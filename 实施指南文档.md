## 调音风格匹配工具 — 实施与部署指南

本指南面向将项目部署到自有云服务器的场景，默认使用 Linux x86_64；如为 Windows Server，请按等价命令替换。

### 1. 环境准备
- OS: Ubuntu 22.04 LTS（或等价）
- 组件：Docker 24+、Docker Compose v2、NVIDIA Driver（可选，GPU）
- 依赖：git、curl、ffmpeg、sox

### 2. 基础设施与账号
- 对象存储：S3 兼容（可选 MinIO 自建），创建私有桶：`audio`, `preset`, `viz`。
- 数据库：PostgreSQL 14+（托管或自建）。
- 队列：RabbitMQ（或 Redis 7）。
- 监控：Prometheus + Grafana；日志：ELK/Opensearch（可后装）。

### 3. 服务组件
1) API 网关（FastAPI/NestJS）
2) 任务编排器（Scheduler）
3) Worker（DSP/ML 引擎，支持 GPU）
4) 前端控制台（React 静态资源）
5) PostgreSQL / RabbitMQ / MinIO（可托管或 docker）

### 4. 参考目录结构
```
/srv/audio-style
  /api
  /scheduler
  /worker
  /frontend
  /deploy
    docker-compose.yml
    .env
```

### 5. 配置 `.env` 示例（关键）
```
APP_ENV=prod
JWT_SECRET=请替换

DB_URL=postgresql://user:pass@postgres:5432/audio
QUEUE_URL=amqp://user:pass@rabbitmq:5672/

S3_ENDPOINT=http://minio:9000
S3_ACCESS_KEY=xxx
S3_SECRET_KEY=yyy
S3_BUCKET_AUDIO=audio
S3_BUCKET_PRESET=preset
S3_BUCKET_VIZ=viz

ENABLE_GPU=false
```

### 6. docker-compose 示例
```yaml
version: '3.9'
services:
  api:
    image: yourrepo/audio-style-api:latest
    env_file: .env
    ports: ["8080:8080"]
    depends_on: [scheduler, rabbitmq, postgres]

  scheduler:
    image: yourrepo/audio-style-scheduler:latest
    env_file: .env
    depends_on: [rabbitmq, postgres]

  worker:
    image: yourrepo/audio-style-worker:latest
    env_file: .env
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
    depends_on: [rabbitmq, minio]

  postgres:
    image: postgres:14
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: audio
    volumes:
      - db:/var/lib/postgresql/data

  rabbitmq:
    image: rabbitmq:3-management
    ports: ["15672:15672"]
    volumes:
      - mq:/var/lib/rabbitmq

  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: xxx
      MINIO_ROOT_PASSWORD: yyy
    ports: ["9000:9000","9001:9001"]
    volumes:
      - s3:/data

volumes:
  db:
  mq:
  s3:
```

### 7. 构建镜像（示例命令）
```bash
docker build -t yourrepo/audio-style-api ./api
docker build -t yourrepo/audio-style-scheduler ./scheduler
docker build -t yourrepo/audio-style-worker ./worker
```

### 8. 启动与验证
```bash
cd /srv/audio-style/deploy
docker compose up -d
curl -f http://localhost:8080/health
```
- 上传测试：调用 `POST /jobs`，带参考与目标音频的签名 URL；轮询 `GET /jobs/{id}`。

### 9. 备份与恢复
- PostgreSQL：每日全量 + WAL 归档；MinIO 桶跨机复制；RabbitMQ 队列镜像。

### 10. 安全加固
- 仅开放 80/443/8080/15672/9000/9001 必要端口；其余入站关闭。
- API 采用 HTTPS（反向代理 NGINX + 证书）；JWT/OAuth2；最小权限的 S3 策略。
- 文件扫描（MIME 校验/大小限制/病毒扫）与内容访问审计。

### 11. 运维与监控
- 导出指标：任务状态、STFT/Mel 距离、LUFS 误差、渲染速度、GPU 利用率。
- 告警：任务失败率阈值、处理时长 P95、磁盘水位、真峰值过载率。

### 12. 性能优化建议
- 长音频切片并行；IR 分区卷积；ONNX/TensorRT；混精度；
- 透传零拷贝（对象存储直读直写）；
- 冷热分层存储：原始/结果热存，分析中间件冷热分层。

### 13. 灰度与回滚
- 蓝绿部署或金丝雀；数据库迁移采用向前兼容策略；
- 镜像采用不可变 Tag；一键回滚至上一个稳定版本。

### 附录A：腾讯云部署指引（CVM + COS + CLB + TCR）

1) **对象存储 COS**
   - 创建私有存储桶：`audio`、`preset`、`viz`（地域与CVM同区优先）。
   - 生成 **临时密钥（STS）** 供前端直传；服务端使用子账号的长期密钥访问。
   - 示例环境变量：
   ```
   S3_ENDPOINT=https://cos.<region>.myqcloud.com
   S3_ACCESS_KEY=AKIDxxxxxxxx
   S3_SECRET_KEY=xxxxxxxxxxxx
   S3_BUCKET_AUDIO=audio-123456
   ```

2) **容器镜像仓库 TCR**
   - 创建 TCR 实例与命名空间，开通公网访问或专线VPC。
   - 登录并推送镜像：
   ```bash
   docker login <tcr-instance>.tencentcloudcr.com
   docker tag yourrepo/audio-style-api <tcr-instance>.tencentcloudcr.com/prod/audio-style-api:v0.1
   docker push <tcr-instance>.tencentcloudcr.com/prod/audio-style-api:v0.1
   # 其他服务同理
   ```

3) **CVM 与安全组**
   - 选用 Ubuntu 22.04、标准型S5 或计算型；如用 GPU，选 NVIDIA T4/A10 型号并安装驱动。
   - 安全组仅放行：80/443/8080（API）、15672（RabbitMQ 管理台按需）、9000/9001（MinIO按需内网）。

4) **CLB 与 HTTPS**
   - 购买/创建 **应用型负载均衡 CLB**，监听 80/443；后端指向 API 实例 8080 端口。
   - 在“SSL 证书管理”上传域名证书（或通过腾讯云申请免费证书），绑定到 CLB 的 443 监听器。

5) **CAM 最小权限策略（示例）**
   - 为“后端服务账号”绑定只读/写入限定到指定桶的策略：
   ```json
   {
     "version": "2.0",
     "statement": [
       {"effect": "allow","action": ["cos:GetObject","cos:HeadObject"],"resource": ["qcs::cos:<region>:uid/<appid>:<bucket>/*.*"]},
       {"effect": "allow","action": ["cos:PutObject","cos:InitiateMultipartUpload","cos:UploadPart","cos:CompleteMultipartUpload"],"resource": ["qcs::cos:<region>:uid/<appid>:<bucket>/*.*"]}
     ]
   }
   ```

6) **日志与监控**
   - 日志服务 CLS：采集 Docker 容器标准输出到日志主题，设置关键字告警（error/exception）。
   - 监控：托管 Prometheus（TMP）拉取 `api/worker` 指标；Grafana 看板导入。

7) **对象直传（前端）**
   - 使用 STS 临时凭证与 COS SDK 分片上传；后端仅签发策略，避免大文件经 API 中转。

8) **Kubernetes（可选）**
   - 若使用 TKE：将 `docker-compose` 拆分为 Deployment/StatefulSet，使用 **外部COS CSI 或 SDK直连**；
   - GPU 节点开启 `NVIDIA Device Plugin`；为 Worker 设置 `resources.requests/limits` 与 `nodeSelector`。


