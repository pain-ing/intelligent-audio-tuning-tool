## 调音风格匹配工具 — 技术架构文档

### 1. 总览
- **形态**: 云端后端 API + Web 管理台/桌面客户端；核心 DSP/ML 引擎可编译为本地库与服务。
- **核心流程**: 上传 → 预处理/分析 → 参考风格参数估计 → 应用到目标音频 → 渲染/导出 → 结果与预设存储。

### 2. 组件划分
1) **API 网关**: HTTP/HTTPS，鉴权、限流、请求签名；反向代理至后端。
2) **任务编排服务**: 接收创建任务，生成分析/匹配/渲染子任务，推送到队列。
3) **工作进程（Worker）**: 读取队列执行子任务；调用 DSP/ML 引擎；支持 GPU。
4) **DSP/ML 引擎**: C++/Rust（JUCE/FFTW/RTConvolution）+ PyTorch/ONNX Runtime（DDSP/检测器）。
5) **对象存储**: 原始/中间/结果音频与IR/预设文件（私有桶，签名URL）。
6) **数据库**: 任务状态、参数预设、审计日志、用户与计费。
7) **消息与队列**: RabbitMQ/Redis Streams，用于任务排队与状态回传。
8) **监控与日志**: Prometheus + Grafana；ELK/Opensearch；S3 Access Logs。
9) **前端**: Web 控制台（上传、进度、可视化、下载、预设管理）。

### 3. 数据流（时序）
1) 客户端上传参考与目标音频 → 对象存储生成 Key；
2) API 创建任务（A/B 模式、选项）→ 任务编排写 DB 并入队；
3) Worker 拉取任务：
   - 预处理：重采样、声道/相位对齐、响度基准化；
   - 分析：谱/包络/F0/空间/动态等特征；
   - 参数反演：EQ/IR/动态/激励/立体声像/音高；
   - 应用与渲染：流式分块，状态管理，生成结果；
4) 结果写对象存储与预设表；状态回写 DB；
5) 客户端轮询/回调获取下载链接与可视化数据。

### 4. 存储设计
- 对象存储（如 S3/OSS/COS）：`audio/raw/`、`audio/processed/`、`ir/`、`preset/`、`viz/`。
- 数据库表：`users`、`jobs`、`job_segments`、`presets`、`metrics`、`audit_logs`、`billing`。
- 结果可视化数据（JSON）：LUFS 轨迹、GR 曲线、F0、M/S 能量、STFT 采样点。

### 5. 关键算法接口（引擎 API）
- `analyze_features(audio)` → features
- `invert_params(reference_features, target_features, mode)` → style_params
- `render(audio, style_params, streaming)` → processed_audio
- `export_preset(style_params)` → preset.json / .vstpreset

### 6. 性能与扩展性
- Worker 无状态，可水平扩展；长任务采用分段切片（如 60s/段）并行处理。
- IR 卷积采用分区卷积（Uniform Partitioned FFT）；STFT 多线程；ONNX/TensorRT GPU 推理。
- 大文件分片上传与断点续传；结果分段合并时做交叠拼接与尾音保护。

### 7. 安全
- JWT/OAuth2 鉴权；STS 临时凭证上传；最小权限访问策略；
- 服务器磁盘与桶加密；签名 URL 有效期；
- 审计日志、请求签名、防盗链；防止音频内容被公开分发。

### 8. 部署拓扑
- **单区基础版**: 1×API 网关 + 1×编排服务 + N×Worker（CPU/GPU 混部）+ RDS + 对象存储 + 队列 + 监控。
- **高可用**: API/编排多实例；队列镜像；RDS 主从；对象存储跨区冗余；负载均衡（ALB/NGINX）。

### 9. 技术选型（建议）
- 后端：Python FastAPI / Node.js NestJS；
- Worker：Python + Rust 插件（pyo3/wasm）或纯 C++ 服务；
- DSP：FFTW/Intel MKL、JUCE、libsamplerate、Rubber Band；
- ML：PyTorch→ONNX Runtime；
- 队列：RabbitMQ 或 Redis Streams；数据库：PostgreSQL；对象存储：S3 兼容；
- 可视化：ECharts/Plotly；前端：React + Tailwind/AntD。

### 10. 容量规划（首版）
- 假设日处理 1,000 个 5 分钟单声道任务；平均 1.2× 实时离线速度。
- 需要 Worker CPU 核数约：1000×5min / (24h×60min) × 1.2 ≈ 4.2 核·持续；考虑并发峰值×5，准备 24~32 vCPU。
- 存储：原始+结果约 15 MB/分钟（WAV 压缩后可降至 5~8 MB/分钟）；预留 10 TB/月。

### 11. 监控指标
- 任务生命周期：排队/执行/失败率/重试；
- 资源：CPU/GPU/内存/磁盘/网络；
- 音频质量：STFT/Mel 距离、LUFS 误差、TP、限幅触发率；
- 应用：API P95 延迟、上传/下载失败率、签名URL使用率。




### 12. 算法接口与数据结构约定（MVP 详细）

- 引擎以“分析→反演→渲染”为主流程，统一采用 UTF-8 JSON 作为参数与特征的载体；大文件仅以对象存储 Key 传递。
- 所有数值单位在字段名或注释中标注（如 dB、Hz、秒）。

接口示意（Python 伪代码/签名）：

```python
from typing import Dict, List, Literal, Optional, Tuple

Mode = Literal["A", "B"]

def analyze_features(obj_key: str, *, sample_rate: int = 48000, stereo: bool = True) -> Dict:
    """解码+重采样→特征提取；返回可序列化 JSON。
    返回字段（示例）：{
      "stft": {"win": 2048, "hop": 512, "mag_db_stats": [...]},
      "mel": {"n_mels": 128, "stats": [...]},
      "lufs": {"integrated": -14.2, "short_term": [...]},
      "tp_db": -1.1,
      "f0": {"algo": "yin", "values": [...], "sr_hz": 100},
      "stereo": {"ms_energy": {...}, "coherence": [...]},
      "reverb": {"rt60_s": 0.8, "edc": [...]}
    }
    """

def invert_params(ref: Dict, tgt: Dict, *, mode: Mode) -> Dict:
    """根据参考/目标特征估计风格参数 style_params。
    返回（示例）：{
      "eq": [{"type":"peaking","f_hz":1000,"q":1.0,"gain_db":-2.5}],
      "lufs": {"target_db": -14.0},
      "limiter": {"tp_db": -1.0, "lookahead_ms": 1.0},
      "reverb": {"ir_key": "ir/hall_a.wav", "mix": 0.12},
      "stereo": {"width": 1.15},
      "pitch": {"semitones": 0.0}
    }
    """

def render(in_key: str, style_params: Dict, *, streaming: bool = True,
           chunk_sec: float = 6.0, overlap: float = 0.5) -> Tuple[str, Dict]:
    """将 style_params 应用于目标音频；返回 (out_key, metrics)。
    metrics（示例）：{"stft_dist": 0.23, "mel_dist": 0.19, "lufs_err": 0.2, "tp_db": -1.0}
    """

def export_preset(style_params: Dict) -> Dict:
    """返回可保存到 presets 表/对象存储的 JSON（可含 IR 依赖引用）。"""
```

style_params 约定（MVP）
- eq: 最多 8 段；每段 {type, f_hz, q(或bw_oct), gain_db}
- limiter: {tp_db, lookahead_ms, release_ms}
- lufs: {target_db}
- reverb: {ir_key, mix(0-1), pre_delay_ms?}
- stereo: {width(0.5~1.5)}
- pitch: {semitones(-3~+3)}

### 13. 任务状态机、幂等与重试策略

状态流转（jobs.status）
- PENDING → ANALYZING → INVERTING → RENDERING → COMPLETED | FAILED
- 任何子步骤失败：记录 error 与 last_step，进入 FAILED；允许客户端发起“重试”，服务端读取幂等键确保不重复入队。

幂等与重试
- 幂等键：哈希(mode, ref_key, tgt_key, opts)；同键在排队/执行时拒绝重复创建。
- 重试：指数退避（2^n 秒，n≤5），对可恢复错误（暂时性 I/O、队列、对象存储 5xx）。
- 死信：超过最大重试计数入死信队列，需人工/定时任务清理或二次处理。

进度与指标
- progress 按子步骤/分段推进（0~100）；metrics 累计写入（stft_dist, mel_dist, lufs_err, tp_db, artifacts_rate）。

### 14. 分块策略与“状态化处理器”接口

分块与拼接
- chunk_sec 默认 6s，overlap 0.5；OLA 交叉淡化窗：Hann；相位一致性检查。
- 长尾效果（混响、压缩包络）需跨块状态延续至下一块；最后一块延长尾音护尾区（>=1.0s）。

处理器接口（伪代码）
```python
class Processor:
    def reset(self, sr: int, channels: int, params: Dict): ...
    def process(self, x: "np.ndarray[frames, channels]", state: Optional[Dict]) -> Tuple["np.ndarray", Dict]: ...
```

跨块 state schema（示例）
- compressor: {env_l: float, env_r: float}
- reverb: {ir_tail_buf: base64, pos: int}
- limiter: {gain_recovery: float}

### 15. API 契约（MVP）

鉴权
- POST /auth/login → {access_token, refresh_token}
- POST /auth/refresh → {access_token}

上传签名
- POST /uploads/sign  请求：{content_type, ext} 响应：{put_url, key, expires}

任务
- POST /jobs  请求：{mode:"A|B", ref_key, tgt_key, opts?}  响应：{job_id}
- GET /jobs/{id} 响应：{status, progress, download_url?, viz_urls?, metrics?, error?}
- POST /jobs/{id}/retry  响应：{status}

预设
- GET /presets → 列表
- POST /presets  请求：{name, style_params}
- GET /presets/{id} → {style_params}

健康检查
- GET /health → {ok: true}

错误规范
- 统一错误体：{code, message, detail?}；常见 code：INVALID_INPUT, NOT_FOUND, RATE_LIMITED, INTERNAL。

### 16. 数据模型字段定义（PostgreSQL）

users
- id(uuid PK), email(text uniq), plan(text), created_at(timestamptz)

jobs
- id(uuid PK), user_id(uuid FK), mode(text), ref_key(text), tgt_key(text),
  status(text), progress(int2), params(jsonb), metrics(jsonb), error(text),
  created_at(timestamptz), updated_at(timestamptz)

job_segments
- id(uuid PK), job_id(uuid FK), idx(int), status(text), started_at(timestamptz),
  finished_at(timestamptz), metrics(jsonb)

presets
- id(uuid PK), user_id(uuid FK), name(text), style_params(jsonb), public(bool), created_at(timestamptz)

metrics（历史快照）
- id(uuid PK), job_id(uuid FK), stft_dist(float4), mel_dist(float4), lufs_err(float4), tp_db(float4), artifacts_rate(float4), created_at(timestamptz)

audit_logs
- id(uuid PK), user_id(uuid FK), action(text), target(text), payload(jsonb), created_at(timestamptz)

约束与索引
- jobs(status), jobs(user_id, created_at desc)，presets(user_id,name uniq 软约束)，
- 大字段（metrics）走 jsonb_path_ops GIN；对象 key 仅存路径字符串，不落地二进制。